package com.kscold.blog.service;

import com.kscold.blog.model.Category;
import com.kscold.blog.repository.CategoryRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class CategoryService {

    private final CategoryRepository categoryRepository;
    private static final int MAX_DEPTH = 4; // 0-4 = 5단계

    @Transactional
    public Category create(Category category) {
        // Slug 생성 (이름을 kebab-case로 변환)
        if (category.getSlug() == null) {
            category.setSlug(generateSlug(category.getName()));
        }

        // 부모가 있는 경우
        if (category.getParent() != null) {
            Category parent = categoryRepository.findById(category.getParent())
                    .orElseThrow(() -> new RuntimeException("부모 카테고리를 찾을 수 없습니다"));

            // 깊이 체크 (최대 5단계)
            if (parent.getDepth() >= MAX_DEPTH) {
                throw new RuntimeException("카테고리는 최대 5단계까지만 생성할 수 있습니다");
            }

            // Ancestors 설정 (부모의 ancestors + 부모 ID)
            List<String> ancestors = new ArrayList<>(parent.getAncestors());
            ancestors.add(parent.getId());
            category.setAncestors(ancestors);
            category.setDepth(parent.getDepth() + 1);
        } else {
            // 루트 카테고리
            category.setAncestors(new ArrayList<>());
            category.setDepth(0);
        }

        return categoryRepository.save(category);
    }

    public List<Category> getTree() {
        // 모든 카테고리 조회
        List<Category> allCategories = categoryRepository.findAll();

        // 루트 카테고리만 필터링 (parent가 null인 것들)
        return allCategories.stream()
                .filter(c -> c.getParent() == null)
                .map(root -> buildTree(root, allCategories))
                .collect(Collectors.toList());
    }

    private Category buildTree(Category category, List<Category> allCategories) {
        // 자식 카테고리 찾기
        List<Category> children = allCategories.stream()
                .filter(c -> category.getId().equals(c.getParent()))
                .sorted((a, b) -> Integer.compare(a.getOrder(), b.getOrder()))
                .map(child -> buildTree(child, allCategories))
                .collect(Collectors.toList());

        // Note: Category 모델에 children 필드가 없으므로
        // 응답 DTO에서 처리하거나, 재귀적으로 조회
        return category;
    }

    public List<Category> getByParent(String parentId) {
        if (parentId == null) {
            return categoryRepository.findByParentIsNull();
        }
        return categoryRepository.findByParentOrderByOrderAsc(parentId);
    }

    public Category getById(String id) {
        return categoryRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("카테고리를 찾을 수 없습니다"));
    }

    public Category getBySlug(String slug) {
        return categoryRepository.findBySlug(slug)
                .orElseThrow(() -> new RuntimeException("카테고리를 찾을 수 없습니다"));
    }

    @Transactional
    public Category update(String id, Category updated) {
        Category category = getById(id);

        category.setName(updated.getName());
        category.setDescription(updated.getDescription());
        category.setIcon(updated.getIcon());
        category.setColor(updated.getColor());

        if (updated.getSlug() != null) {
            category.setSlug(updated.getSlug());
        }

        return categoryRepository.save(category);
    }

    @Transactional
    public void delete(String id) {
        Category category = getById(id);

        // 자식 카테고리가 있는지 확인
        List<Category> children = categoryRepository.findByParent(id);
        if (!children.isEmpty()) {
            throw new RuntimeException("하위 카테고리가 있는 카테고리는 삭제할 수 없습니다");
        }

        categoryRepository.delete(category);
    }

    @Transactional
    public Category move(String id, String newParentId) {
        Category category = getById(id);
        Category newParent = newParentId != null ? getById(newParentId) : null;

        // 자신의 자식으로 이동하는 것 방지
        if (newParent != null && newParent.getAncestors().contains(id)) {
            throw new RuntimeException("카테고리를 자신의 하위 카테고리로 이동할 수 없습니다");
        }

        // 깊이 체크
        if (newParent != null && newParent.getDepth() >= MAX_DEPTH) {
            throw new RuntimeException("카테고리는 최대 5단계까지만 생성할 수 있습니다");
        }

        // 부모 및 ancestors 업데이트
        category.setParent(newParentId);

        if (newParent != null) {
            List<String> ancestors = new ArrayList<>(newParent.getAncestors());
            ancestors.add(newParent.getId());
            category.setAncestors(ancestors);
            category.setDepth(newParent.getDepth() + 1);
        } else {
            category.setAncestors(new ArrayList<>());
            category.setDepth(0);
        }

        // 자식 카테고리들도 재귀적으로 업데이트
        updateChildrenAncestors(category);

        return categoryRepository.save(category);
    }

    private void updateChildrenAncestors(Category parent) {
        List<Category> children = categoryRepository.findByParent(parent.getId());

        for (Category child : children) {
            List<String> ancestors = new ArrayList<>(parent.getAncestors());
            ancestors.add(parent.getId());
            child.setAncestors(ancestors);
            child.setDepth(parent.getDepth() + 1);

            categoryRepository.save(child);
            updateChildrenAncestors(child);
        }
    }

    private String generateSlug(String name) {
        return name.toLowerCase()
                .replaceAll("[^a-z0-9가-힣\\s-]", "")
                .replaceAll("\\s+", "-")
                .trim();
    }
}
